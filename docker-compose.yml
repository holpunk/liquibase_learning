version: '3.8'

services:
  # Source: Simulated On-Premise DB2
  db2:
    image: icr.io/db2_community/db2
    container_name: db2-source
    environment:
      - LICENSE=accept
      - DB2INST1_PASSWORD=${DB2_PASSWORD}
      - DBNAME=${DB2_DB_NAME}
      - ARCHIVE_LOGS=false
      - AUTOCONFIG=false
    ports:
      - "50000:50000"
    privileged: true
    healthcheck:
      test: [ "CMD-SHELL", "db2 ping ${DB2_DB_NAME} || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # Target: Simulated AWS RDS (PostgreSQL)
  postgres:
    image: postgres:15
    container_name: postgres-target
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Liquibase Runner (Optional, for manual commands)
  liquibase:
    image: liquibase/liquibase:latest
    container_name: liquibase-runner
    volumes:
      - ./changelogs:/liquibase/changelogs
      - ./scripts:/liquibase/scripts
    # Example command (doesn't run automatically)
    command: --help
    depends_on:
      - db2
      - postgres
